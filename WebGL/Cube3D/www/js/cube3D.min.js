Bridge.define("Cube3D.App",{statics:{config:{init:function(){Bridge.ready(this.main)}},main:function(){Cube3D.App.initCube("canvas1")},initCube:function(n){var t=new Cube3D.Cube;Cube3D.App.initSettings(t);t.canvas=Cube3D.App.getCanvasEl(n);t.gl=Cube3D.App.create3DContext(t.canvas);t.gl!==null?(t.initShaders(),t.initBuffers(),t.initTexture(),t.tick(),document.addEventListener("keydown",Bridge.fn.bind(t,t.handleKeyDown)),document.addEventListener("keyup",Bridge.fn.bind(t,t.handleKeyUp))):Cube3D.App.showError(t.canvas,'<b>Either the browser doesn\'t support WebGL or it is disabled.<br>Please follow <a href="http://get.webgl.com">Get WebGL<\/a>.<\/b>')},getCanvasEl:function(n){return document.getElementById(n)},create3DContext:function(n){for(var i=null,r,t=Bridge.getEnumerator(["webgl","experimental-webgl","webkit-3d","moz-webgl"]);t.moveNext();){r=t.getCurrent();try{i=n.getContext(r)}catch(u){}if(i!==null)break}return i},showError:function(n,t){document.body.replaceChild(Bridge.merge(document.createElement("p"),{innerHTML:t}),n)},initSettings:function(n){n.useBlending=document.getElementById("blending").checked;n.alpha=parseFloat(document.getElementById("alpha").value);n.useLighting=document.getElementById("lighting").checked;n.ambientR=parseFloat(document.getElementById("ambientR").value);n.ambientG=parseFloat(document.getElementById("ambientG").value);n.ambientB=parseFloat(document.getElementById("ambientB").value);n.lightDirectionX=parseFloat(document.getElementById("lightDirectionX").value);n.lightDirectionY=parseFloat(document.getElementById("lightDirectionY").value);n.lightDirectionZ=parseFloat(document.getElementById("lightDirectionZ").value);n.directionalR=parseFloat(document.getElementById("directionalR").value);n.directionalG=parseFloat(document.getElementById("directionalG").value);n.directionalB=parseFloat(document.getElementById("directionalB").value);n.textureImageSrc="crate.gif"}}});Bridge.define("Cube3D.Cube",{canvas:null,gl:null,program:null,texture:null,useBlending:!1,alpha:0,useLighting:!1,ambientR:0,ambientG:0,ambientB:0,lightDirectionX:0,lightDirectionY:0,lightDirectionZ:0,directionalR:0,directionalG:0,directionalB:0,textureImageSrc:null,vertexPositionAttribute:0,vertexNormalAttribute:0,textureCoordAttribute:0,pMatrixUniform:null,mvMatrixUniform:null,nMatrixUniform:null,samplerUniform:null,useLightingUniform:null,ambientColorUniform:null,lightingDirectionUniform:null,directionalColorUniform:null,alphaUniform:null,cubeVertexPositionBuffer:null,cubeVertexNormalBuffer:null,cubeVertexTextureCoordBuffer:null,cubeVertexIndexBuffer:null,xRotation:0,xSpeed:15,yRotation:0,lastTime:0,config:{init:function(){this.mvMatrix=mat4.create();this.mvMatrixStack=[];this.pMatrix=mat4.create();this.ySpeed=-15;this.z=-5;this.currentlyPressedKeys=[]}},getShader:function(n,t){var u=document.getElementById(t),f,r,i;if(u===null)return null;for(f="",r=u.firstChild;r!==null;)r.nodeType===3&&(f+=r.textContent),r=r.nextSibling;if(u.type==="x-shader/x-fragment")i=n.createShader(n.FRAGMENT_SHADER);else if(u.type==="x-shader/x-vertex")i=n.createShader(n.VERTEX_SHADER);else return null;return(n.shaderSource(i,f),n.compileShader(i),!n.getShaderParameter(i,n.COMPILE_STATUS))?(Bridge.global.alert(n.getShaderInfoLog(i)),null):i},initShaders:function(){var t=this.getShader(this.gl,"shader-fs"),i=this.getShader(this.gl,"shader-vs"),n=this.gl.createProgram();Bridge.is(n,Bridge.Int)&&Bridge.global.alert("Could not initialise program");this.gl.attachShader(n,i);this.gl.attachShader(n,t);this.gl.linkProgram(n);this.gl.getProgramParameter(n,this.gl.LINK_STATUS)||Bridge.global.alert("Could not initialise shaders");this.gl.useProgram(n);this.vertexPositionAttribute=this.gl.getAttribLocation(n,"aVertexPosition");this.vertexNormalAttribute=this.gl.getAttribLocation(n,"aVertexNormal");this.textureCoordAttribute=this.gl.getAttribLocation(n,"aTextureCoord");this.gl.enableVertexAttribArray(this.vertexPositionAttribute);this.gl.enableVertexAttribArray(this.vertexNormalAttribute);this.gl.enableVertexAttribArray(this.textureCoordAttribute);this.pMatrixUniform=this.gl.getUniformLocation(n,"uPMatrix");this.mvMatrixUniform=this.gl.getUniformLocation(n,"uMVMatrix");this.nMatrixUniform=this.gl.getUniformLocation(n,"uNMatrix");this.samplerUniform=this.gl.getUniformLocation(n,"uSampler");this.useLightingUniform=this.gl.getUniformLocation(n,"uUseLighting");this.ambientColorUniform=this.gl.getUniformLocation(n,"uAmbientColor");this.lightingDirectionUniform=this.gl.getUniformLocation(n,"uLightingDirection");this.directionalColorUniform=this.gl.getUniformLocation(n,"uDirectionalColor");this.alphaUniform=this.gl.getUniformLocation(n,"uAlpha");this.program=n},handleLoadedTexture:function(n){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);this.gl.bindTexture(this.gl.TEXTURE_2D,null)},initTexture:function(){this.texture=this.gl.createTexture();var n=new Image;n.onload=Bridge.fn.bind(this,function(){this.handleLoadedTexture(n)});n.src=this.textureImageSrc},setMatrixUniforms:function(){this.gl.uniformMatrix4fv(this.pMatrixUniform,!1,this.pMatrix);this.gl.uniformMatrix4fv(this.mvMatrixUniform,!1,this.mvMatrix);var n=mat3.create();mat4.toInverseMat3(this.mvMatrix,n);mat3.transpose(n);this.gl.uniformMatrix3fv(this.nMatrixUniform,!1,n)},degToRad:function(n){return n*Math.PI/180},handleKeyDown:function(n){this.currentlyPressedKeys[n.keyCode]=!0},handleKeyUp:function(n){this.currentlyPressedKeys[n.keyCode]=!1},handleKeys:function(){this.currentlyPressedKeys[81]&&(this.z-=.05);this.currentlyPressedKeys[69]&&(this.z+=.05);this.currentlyPressedKeys[65]&&(this.ySpeed-=1);this.currentlyPressedKeys[68]&&(this.ySpeed+=1);this.currentlyPressedKeys[83]&&(this.xSpeed-=1);this.currentlyPressedKeys[87]&&(this.xSpeed+=1)},initBuffers:function(){var n,t,i,r;this.cubeVertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexPositionBuffer);n=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(n),this.gl.STATIC_DRAW);this.cubeVertexNormalBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexNormalBuffer);t=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW);this.cubeVertexTextureCoordBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer);i=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(i),this.gl.STATIC_DRAW);this.cubeVertexIndexBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);r=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),this.gl.STATIC_DRAW)},drawScene:function(){if(this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),mat4.perspective(45,Bridge.cast(this.canvas.width,Number)/this.canvas.height,.1,100,this.pMatrix),mat4.identity(this.mvMatrix),mat4.translate(this.mvMatrix,[0,0,this.z]),mat4.rotate(this.mvMatrix,this.degToRad(this.xRotation),[1,0,0]),mat4.rotate(this.mvMatrix,this.degToRad(this.yRotation),[0,1,0]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexPositionBuffer),this.gl.vertexAttribPointer(this.vertexPositionAttribute,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexNormalBuffer),this.gl.vertexAttribPointer(this.vertexNormalAttribute,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer),this.gl.vertexAttribPointer(this.textureCoordAttribute,2,this.gl.FLOAT,!1,0,0),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.uniform1i(this.samplerUniform,0),this.useBlending?(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this.gl.enable(this.gl.BLEND),this.gl.disable(this.gl.DEPTH_TEST),this.gl.uniform1f(this.alphaUniform,this.alpha)):(this.gl.disable(this.gl.BLEND),this.gl.enable(this.gl.DEPTH_TEST),this.gl.uniform1f(this.alphaUniform,1)),this.gl.uniform1i(this.useLightingUniform,this.useLighting),this.useLighting){this.gl.uniform3f(this.ambientColorUniform,this.ambientR,this.ambientG,this.ambientB);var t=[this.lightDirectionX,this.lightDirectionY,this.lightDirectionZ],n=vec3.create();vec3.normalize(t,n);vec3.scale(n,-1);this.gl.uniform3fv(this.lightingDirectionUniform,n);this.gl.uniform3f(this.directionalColorUniform,this.directionalR,this.directionalG,this.directionalB)}this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);this.setMatrixUniforms();this.gl.drawElements(this.gl.TRIANGLES,36,this.gl.UNSIGNED_SHORT,0)},animate:function(){var t=(new Date).getTime(),n;this.lastTime!==0&&(n=t-this.lastTime,this.xRotation+=this.xSpeed*n/1e3,this.yRotation+=this.ySpeed*n/1e3);this.lastTime=t},tick:function(){Cube3D.App.initSettings(this);this.handleKeys();this.drawScene();this.animate();Bridge.global.setTimeout(Bridge.fn.bind(this,this.tick),20)}})