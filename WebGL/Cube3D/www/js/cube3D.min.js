Bridge.define("Cube3D.Draw",{statics:{canvas:null,gL:null,program:null,texture:null,vertexPositionAttribute:0,vertexNormalAttribute:0,textureCoordAttribute:0,pMatrixUniform:null,mvMatrixUniform:null,nMatrixUniform:null,samplerUniform:null,cubeVertexPositionBuffer:null,cubeVertexNormalBuffer:null,cubeVertexTextureCoordBuffer:null,cubeVertexIndexBuffer:null,xRot:0,xSpeed:3,yRot:0,lastTime:0,config:{init:function(){this.mvMatrix=mat4.create();this.mvMatrixStack=[];this.pMatrix=mat4.create();this.ySpeed=-3;this.z=-5;this.currentlyPressedKeys=[];Bridge.ready(this.webGLStart)}},create3DContext:function(n){for(var i=null,r,t=Bridge.getEnumerator(["webgl","experimental-webgl","webkit-3d","moz-webgl"]);t.moveNext();){r=t.getCurrent();try{i=n.getContext(r)}catch(u){}if(i!==null)break}return i},initGL:function(n){var t=Cube3D.Draw.create3DContext(n);t===null&&window.alert("Could not initialise WebGL, sorry :-(");Cube3D.Draw.gL=t},getShader:function(n,t){var u=document.getElementById(t),f,r,i;if(u===null)return null;for(f="",r=u.firstChild;r!==null;)r.nodeType===3&&(f+=r.textContent),r=r.nextSibling;if(u.type==="x-shader/x-fragment")i=n.createShader(n.FRAGMENT_SHADER);else if(u.type==="x-shader/x-vertex")i=n.createShader(n.VERTEX_SHADER);else return null;return(n.shaderSource(i,f),n.compileShader(i),!n.getShaderParameter(i,n.COMPILE_STATUS))?(window.alert(n.getShaderInfoLog(i)),null):i},initShaders:function(){var n=Cube3D.Draw.gL,i=Cube3D.Draw.getShader(n,"shader-fs"),r=Cube3D.Draw.getShader(n,"shader-vs"),t=n.createProgram();Bridge.is(t,Bridge.Int)&&window.alert("Could not initialise program");n.attachShader(t,r);n.attachShader(t,i);n.linkProgram(t);n.getProgramParameter(t,n.LINK_STATUS)||window.alert("Could not initialise shaders");n.useProgram(t);Cube3D.Draw.vertexPositionAttribute=n.getAttribLocation(t,"aVertexPosition");n.enableVertexAttribArray(Cube3D.Draw.vertexPositionAttribute);Cube3D.Draw.vertexNormalAttribute=n.getAttribLocation(t,"aVertexNormal");n.enableVertexAttribArray(Cube3D.Draw.vertexNormalAttribute);Cube3D.Draw.textureCoordAttribute=n.getAttribLocation(t,"aTextureCoord");n.enableVertexAttribArray(Cube3D.Draw.textureCoordAttribute);Cube3D.Draw.pMatrixUniform=n.getUniformLocation(t,"uPMatrix");Cube3D.Draw.mvMatrixUniform=n.getUniformLocation(t,"uMVMatrix");Cube3D.Draw.nMatrixUniform=n.getUniformLocation(t,"uNMatrix");Cube3D.Draw.samplerUniform=n.getUniformLocation(t,"uSampler");Cube3D.Draw.program=t},handleLoadedTexture:function(n){var t=Cube3D.Draw.gL;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0);t.bindTexture(t.TEXTURE_2D,Cube3D.Draw.texture);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST);t.generateMipmap(t.TEXTURE_2D);t.bindTexture(t.TEXTURE_2D,null)},initTexture:function(){var t=Cube3D.Draw.gL,n;Cube3D.Draw.texture=t.createTexture();n=new Image;n.onload=function(){Cube3D.Draw.handleLoadedTexture(n)};n.src="crate.gif"},mVPushMatrix:function(){var n=mat4.create();mat4.set(Cube3D.Draw.mvMatrix,n);Cube3D.Draw.mvMatrixStack.push(n)},mVPopMatrix:function(){if(Cube3D.Draw.mvMatrixStack.length===0)throw new Bridge.Exception("Invalid popMatrix!");Cube3D.Draw.mvMatrix=Cube3D.Draw.mvMatrixStack.pop()},setMatrixUniforms:function(){var t=Cube3D.Draw.gL,n;t.uniformMatrix4fv(Cube3D.Draw.pMatrixUniform,!1,Cube3D.Draw.pMatrix);t.uniformMatrix4fv(Cube3D.Draw.mvMatrixUniform,!1,Cube3D.Draw.mvMatrix);n=mat3.create();mat4.toInverseMat3(Cube3D.Draw.mvMatrix,n);mat3.transpose(n);t.uniformMatrix3fv(Cube3D.Draw.nMatrixUniform,!1,n)},degToRad:function(n){return n*Math.PI/180},handleKeyDown:function(n){Cube3D.Draw.currentlyPressedKeys[n.keyCode]=!0},handleKeyUp:function(n){Cube3D.Draw.currentlyPressedKeys[n.keyCode]=!1},handleKeys:function(){Cube3D.Draw.currentlyPressedKeys[33]&&(Cube3D.Draw.z-=.05);Cube3D.Draw.currentlyPressedKeys[34]&&(Cube3D.Draw.z+=.05);Cube3D.Draw.currentlyPressedKeys[37]&&(Cube3D.Draw.ySpeed-=1);Cube3D.Draw.currentlyPressedKeys[39]&&(Cube3D.Draw.ySpeed+=1);Cube3D.Draw.currentlyPressedKeys[38]&&(Cube3D.Draw.xSpeed-=1);Cube3D.Draw.currentlyPressedKeys[40]&&(Cube3D.Draw.xSpeed+=1)},initBuffers:function(){var n=Cube3D.Draw.gL,t,i,r,u;Cube3D.Draw.cubeVertexPositionBuffer=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,Cube3D.Draw.cubeVertexPositionBuffer);t=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];n.bufferData(n.ARRAY_BUFFER,new Float32Array(t),n.STATIC_DRAW);Cube3D.Draw.cubeVertexNormalBuffer=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,Cube3D.Draw.cubeVertexNormalBuffer);i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0];n.bufferData(n.ARRAY_BUFFER,new Float32Array(i),n.STATIC_DRAW);Cube3D.Draw.cubeVertexTextureCoordBuffer=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,Cube3D.Draw.cubeVertexTextureCoordBuffer);r=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1];n.bufferData(n.ARRAY_BUFFER,new Float32Array(r),n.STATIC_DRAW);Cube3D.Draw.cubeVertexIndexBuffer=n.createBuffer();n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,Cube3D.Draw.cubeVertexIndexBuffer);u=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];n.bufferData(n.ELEMENT_ARRAY_BUFFER,new Uint16Array(u),n.STATIC_DRAW)},drawScene:function(){var n=Cube3D.Draw.gL;n.viewport(0,0,Cube3D.Draw.canvas.width,Cube3D.Draw.canvas.height);n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);mat4.perspective(45,Bridge.cast(Cube3D.Draw.canvas.width,Number)/Cube3D.Draw.canvas.height,.1,100,Cube3D.Draw.pMatrix);mat4.identity(Cube3D.Draw.mvMatrix);mat4.translate(Cube3D.Draw.mvMatrix,[0,0,Cube3D.Draw.z]);mat4.rotate(Cube3D.Draw.mvMatrix,Cube3D.Draw.degToRad(Cube3D.Draw.xRot),[1,0,0]);mat4.rotate(Cube3D.Draw.mvMatrix,Cube3D.Draw.degToRad(Cube3D.Draw.yRot),[0,1,0]);n.bindBuffer(n.ARRAY_BUFFER,Cube3D.Draw.cubeVertexPositionBuffer);n.vertexAttribPointer(Cube3D.Draw.vertexPositionAttribute,3,n.FLOAT,!1,0,0);n.bindBuffer(n.ARRAY_BUFFER,Cube3D.Draw.cubeVertexNormalBuffer);n.vertexAttribPointer(Cube3D.Draw.vertexNormalAttribute,3,n.FLOAT,!1,0,0);n.bindBuffer(n.ARRAY_BUFFER,Cube3D.Draw.cubeVertexTextureCoordBuffer);n.vertexAttribPointer(Cube3D.Draw.textureCoordAttribute,2,n.FLOAT,!1,0,0);n.activeTexture(n.TEXTURE0);n.bindTexture(n.TEXTURE_2D,Cube3D.Draw.texture);n.uniform1i(Cube3D.Draw.samplerUniform,0);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,Cube3D.Draw.cubeVertexIndexBuffer);Cube3D.Draw.setMatrixUniforms();n.drawElements(n.TRIANGLES,36,n.UNSIGNED_SHORT,0)},animate:function(){var t=(new Date).getTime(),n;Cube3D.Draw.lastTime!==0&&(n=t-Cube3D.Draw.lastTime,Cube3D.Draw.xRot+=Cube3D.Draw.xSpeed*n/1e3,Cube3D.Draw.yRot+=Cube3D.Draw.ySpeed*n/1e3);Cube3D.Draw.lastTime=t},tick:function(){requestAnimFrame(Cube3D.Draw.tick);Cube3D.Draw.handleKeys();Cube3D.Draw.drawScene();Cube3D.Draw.animate()},webGLStart:function(){Cube3D.Draw.canvas=document.getElementById("lesson07-canvas");Cube3D.Draw.initGL(Cube3D.Draw.canvas);Cube3D.Draw.initShaders();Cube3D.Draw.initBuffers();Cube3D.Draw.initTexture();var n=Cube3D.Draw.gL;n.clearColor(1,1,1,1);n.enable(n.DEPTH_TEST);document.onkeydown=Cube3D.Draw.handleKeyDown;document.onkeyup=Cube3D.Draw.handleKeyUp;Cube3D.Draw.tick()}}})